(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{372:function(s,t,a){s.exports=a.p+"assets/img/1075473-20180730155111136-745183766.5c9838d5.png"},373:function(s,t,a){s.exports=a.p+"assets/img/1075473-20180730155309716-991924999.97454764.png"},374:function(s,t,a){s.exports=a.p+"assets/img/09f27002e7f5441f825f968446e1a86c.cbaa4963.jpg"},375:function(s,t,a){s.exports=a.p+"assets/img/1075473-20180801182353640-84564117.f4271388.png"},376:function(s,t,a){s.exports=a.p+"assets/img/1174710-20180628011547892-692403928.cbc4a1ef.png"},540:function(s,t,a){"use strict";a.r(t);var e=a(8),r=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("将数据复制多个副本部署到其他的机器")]),s._v(" "),e("h2",{attrs:{id:"配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),e("p",[s._v("参入复制的实例划分为主节点和从节点。复制的数据是单向流动的。默认情况下，从节点为只读状态")]),s._v(" "),e("h3",{attrs:{id:"建立连接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建立连接"}},[s._v("#")]),s._v(" 建立连接")]),s._v(" "),e("ol",[e("li",[s._v("配置文件")])]),s._v(" "),e("p",[s._v("修改从节点的配置文件")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("slaveof {masterHost} {masterPost}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("启动命令后")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("redis-server --slaveof "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("masterHost"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("masterPost"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("命令行")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("cli "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" slaveof "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("masterHost"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("masterPost"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"断开连接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#断开连接"}},[s._v("#")]),s._v(" 断开连接")]),s._v(" "),e("p",[s._v("使用命令断开主从节点的复制.")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("slaveof no one\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",[e("li",[s._v("断开与主节点的复制关系")]),s._v(" "),e("li",[s._v("从节点升级为主节点")])]),s._v(" "),e("blockquote",[e("p",[s._v("断开后不会情况数据")])]),s._v(" "),e("h3",{attrs:{id:"传输延迟"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#传输延迟"}},[s._v("#")]),s._v(" 传输延迟")]),s._v(" "),e("p",[s._v("redis 通过 "),e("code",[s._v("repl-disable-tcp-nodelay")]),s._v(" 参数控制TCP 传输延迟")]),s._v(" "),e("ul",[e("li",[s._v("开启时 主节点会合并tcp数据包从而节省带宽，默认40ms发送一次")]),s._v(" "),e("li",[s._v("关闭时 主节点实时的将数据传输到从节点")])]),s._v(" "),e("h2",{attrs:{id:"拓扑结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#拓扑结构"}},[s._v("#")]),s._v(" 拓扑结构")]),s._v(" "),e("ol",[e("li",[s._v("一主一从")]),s._v(" "),e("li",[s._v("一主多从")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(372),alt:""}})]),s._v(" "),e("ol",{attrs:{start:"3"}},[e("li",[s._v("数状主从结构")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(373),alt:""}})]),s._v(" "),e("h2",{attrs:{id:"复制原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#复制原理"}},[s._v("#")]),s._v(" 复制原理")]),s._v(" "),e("h3",{attrs:{id:"复制过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#复制过程"}},[s._v("#")]),s._v(" 复制过程")]),s._v(" "),e("p",[e("img",{attrs:{src:a(374),alt:""}})]),s._v(" "),e("ol",[e("li",[e("p",[s._v("从节点保存主节点信息")])]),s._v(" "),e("li",[e("p",[s._v("尝试建立主从连接")])]),s._v(" "),e("li",[e("p",[s._v("发送ping命令")])]),s._v(" "),e("li",[e("p",[s._v("权限认证")])]),s._v(" "),e("li",[e("p",[s._v("同步数据")])]),s._v(" "),e("li",[e("p",[s._v("命令持续复制")])])]),s._v(" "),e("h3",{attrs:{id:"数据同步方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据同步方式"}},[s._v("#")]),s._v(" 数据同步方式")]),s._v(" "),e("ul",[e("li",[s._v("复制偏移量")])]),s._v(" "),e("p",[s._v("主库和从库分别各自维护一个复制偏移量（可以使用info replication查看），用于标识自己复制的情况，在主库中代表主节点向从节点传递的字节数，在从库中代表从库同步的字节数.")]),s._v(" "),e("p",[s._v("主节点在处理完写入命令会命令的字节长度做累加记录。")]),s._v(" "),e("ul",[e("li",[s._v("复制积压缓冲区")])]),s._v(" "),e("p",[s._v("复制积压缓冲区是一个固定长度的FIFO队列，大小由配置参数repl-backlog-size指定，默认大小1MB。需要注意的是该缓冲区由master维护并且有且只有一个，所有slave共享此缓冲区，其作用在于备份最近主库发送给从库的数据")]),s._v(" "),e("p",[s._v("主从命令传播阶段，主节点除了将写命令发送给从节点外，还会发送一份到复制积压缓冲区，作为写命令的备份")]),s._v(" "),e("ul",[e("li",[s._v("run_id")])]),s._v(" "),e("p",[s._v("每个redis实例在启动时候，都会随机生成一个长度为40的唯一字符串来标识当前运行的redis节点")]),s._v(" "),e("ol",[e("li",[s._v("如果从节点保存的runid与主节点现在的runid相同，说明主从节点之前同步过，主节点会更具offset偏移量之后的数据判断是否执行部分复制，如果offset偏移量之后的数据仍然都在复制积压缓冲区里，则执行部分复制，否则执行全量复制；")]),s._v(" "),e("li",[s._v("如果从节点保存的runid与主节点现在的runid不同，说明从节点在断线前同步的redis节点并不是当前的主节点，只能进行全量复制")])]),s._v(" "),e("ul",[e("li",[s._v("psync")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(375),alt:""}})]),s._v(" "),e("h4",{attrs:{id:"全量复制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#全量复制"}},[s._v("#")]),s._v(" 全量复制")]),s._v(" "),e("p",[s._v("用于初次复制或其他无法进行部分复制的情况，将主节点中的所有数据都发送给从节点，是一个非常重型的操作")]),s._v(" "),e("h4",{attrs:{id:"部分复制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部分复制"}},[s._v("#")]),s._v(" 部分复制")]),s._v(" "),e("p",[s._v("用于网络中断等情况后的复制，只将中断期间主节点执行的写命令发送给从节点，与全量复制相比更加高效。需要注意的是，如果网络中断时间过长，导致主节点没有能够完整地保存中断期间执行的写命令，则无法进行部分复制，仍使用全量复制")]),s._v(" "),e("p",[e("img",{attrs:{src:a(376),alt:""}})])])}),[],!1,null,null,null);t.default=r.exports}}]);