(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{447:function(t,s,a){t.exports=a.p+"assets/img/1075473-20180730155111136-745183766.5c9838d5.png"},448:function(t,s,a){t.exports=a.p+"assets/img/1075473-20180730155309716-991924999.97454764.png"},449:function(t,s,a){t.exports=a.p+"assets/img/09f27002e7f5441f825f968446e1a86c.cbaa4963.jpg"},450:function(t,s,a){t.exports=a.p+"assets/img/1075473-20180801182353640-84564117.f4271388.png"},451:function(t,s,a){t.exports=a.p+"assets/img/1174710-20180628011547892-692403928.cbc4a1ef.png"},601:function(t,s,a){"use strict";a.r(s);var r=a(28),v=Object(r.a)({},(function(){var t=this,s=t.$createElement,r=t._self._c||s;return r("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[r("p",[t._v("将数据复制多个副本部署到其他的机器")]),t._v(" "),r("h2",{attrs:{id:"配置"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[t._v("#")]),t._v(" 配置")]),t._v(" "),r("p",[t._v("参入复制的实例划分为主节点和从节点。复制的数据是单向流动的。默认情况下，从节点为只读状态")]),t._v(" "),r("h3",{attrs:{id:"建立连接"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#建立连接"}},[t._v("#")]),t._v(" 建立连接")]),t._v(" "),r("ol",[r("li",[t._v("配置文件")])]),t._v(" "),r("p",[t._v("修改从节点的配置文件")]),t._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[t._v("slaveof {masterHost} {masterPost}\n")])])]),r("ol",{attrs:{start:"2"}},[r("li",[t._v("启动命令后")])]),t._v(" "),r("div",{staticClass:"language-shell extra-class"},[r("pre",{pre:!0,attrs:{class:"language-shell"}},[r("code",[t._v("redis-server --slaveof "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("masterHost"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("masterPost"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),r("ol",{attrs:{start:"3"}},[r("li",[t._v("命令行")])]),t._v(" "),r("div",{staticClass:"language-shell extra-class"},[r("pre",{pre:!0,attrs:{class:"language-shell"}},[r("code",[t._v("cli "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" slaveof "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("masterHost"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("masterPost"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),r("h3",{attrs:{id:"断开连接"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#断开连接"}},[t._v("#")]),t._v(" 断开连接")]),t._v(" "),r("p",[t._v("使用命令断开主从节点的复制.")]),t._v(" "),r("div",{staticClass:"language-shell extra-class"},[r("pre",{pre:!0,attrs:{class:"language-shell"}},[r("code",[t._v("slaveof no one\n")])])]),r("ol",[r("li",[t._v("断开与主节点的复制关系")]),t._v(" "),r("li",[t._v("从节点升级为主节点")])]),t._v(" "),r("blockquote",[r("p",[t._v("断开后不会情况数据")])]),t._v(" "),r("h3",{attrs:{id:"传输延迟"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#传输延迟"}},[t._v("#")]),t._v(" 传输延迟")]),t._v(" "),r("p",[t._v("redis 通过 "),r("code",[t._v("repl-disable-tcp-nodelay")]),t._v(" 参数控制TCP 传输延迟")]),t._v(" "),r("ul",[r("li",[t._v("开启时 主节点会合并tcp数据包从而节省带宽，默认40ms发送一次")]),t._v(" "),r("li",[t._v("关闭时 主节点实时的将数据传输到从节点")])]),t._v(" "),r("h2",{attrs:{id:"拓扑结构"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#拓扑结构"}},[t._v("#")]),t._v(" 拓扑结构")]),t._v(" "),r("ol",[r("li",[t._v("一主一从")]),t._v(" "),r("li",[t._v("一主多从")])]),t._v(" "),r("p",[r("img",{attrs:{src:a(447),alt:""}})]),t._v(" "),r("ol",{attrs:{start:"3"}},[r("li",[t._v("数状主从结构")])]),t._v(" "),r("p",[r("img",{attrs:{src:a(448),alt:""}})]),t._v(" "),r("h2",{attrs:{id:"复制原理"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#复制原理"}},[t._v("#")]),t._v(" 复制原理")]),t._v(" "),r("h3",{attrs:{id:"复制过程"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#复制过程"}},[t._v("#")]),t._v(" 复制过程")]),t._v(" "),r("p",[r("img",{attrs:{src:a(449),alt:""}})]),t._v(" "),r("ol",[r("li",[r("p",[t._v("从节点保存主节点信息")])]),t._v(" "),r("li",[r("p",[t._v("尝试建立主从连接")])]),t._v(" "),r("li",[r("p",[t._v("发送ping命令")])]),t._v(" "),r("li",[r("p",[t._v("权限认证")])]),t._v(" "),r("li",[r("p",[t._v("同步数据")])]),t._v(" "),r("li",[r("p",[t._v("命令持续复制")])])]),t._v(" "),r("h3",{attrs:{id:"数据同步方式"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#数据同步方式"}},[t._v("#")]),t._v(" 数据同步方式")]),t._v(" "),r("ul",[r("li",[t._v("复制偏移量")])]),t._v(" "),r("p",[t._v("主库和从库分别各自维护一个复制偏移量（可以使用info replication查看），用于标识自己复制的情况，在主库中代表主节点向从节点传递的字节数，在从库中代表从库同步的字节数.")]),t._v(" "),r("p",[t._v("主节点在处理完写入命令会命令的字节长度做累加记录。")]),t._v(" "),r("ul",[r("li",[t._v("复制积压缓冲区")])]),t._v(" "),r("p",[t._v("复制积压缓冲区是一个固定长度的FIFO队列，大小由配置参数repl-backlog-size指定，默认大小1MB。需要注意的是该缓冲区由master维护并且有且只有一个，所有slave共享此缓冲区，其作用在于备份最近主库发送给从库的数据")]),t._v(" "),r("p",[t._v("主从命令传播阶段，主节点除了将写命令发送给从节点外，还会发送一份到复制积压缓冲区，作为写命令的备份")]),t._v(" "),r("ul",[r("li",[t._v("run_id")])]),t._v(" "),r("p",[t._v("每个redis实例在启动时候，都会随机生成一个长度为40的唯一字符串来标识当前运行的redis节点")]),t._v(" "),r("ol",[r("li",[t._v("如果从节点保存的runid与主节点现在的runid相同，说明主从节点之前同步过，主节点会更具offset偏移量之后的数据判断是否执行部分复制，如果offset偏移量之后的数据仍然都在复制积压缓冲区里，则执行部分复制，否则执行全量复制；")]),t._v(" "),r("li",[t._v("如果从节点保存的runid与主节点现在的runid不同，说明从节点在断线前同步的redis节点并不是当前的主节点，只能进行全量复制")])]),t._v(" "),r("ul",[r("li",[t._v("psync")])]),t._v(" "),r("p",[r("img",{attrs:{src:a(450),alt:""}})]),t._v(" "),r("h4",{attrs:{id:"全量复制"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#全量复制"}},[t._v("#")]),t._v(" 全量复制")]),t._v(" "),r("p",[t._v("用于初次复制或其他无法进行部分复制的情况，将主节点中的所有数据都发送给从节点，是一个非常重型的操作")]),t._v(" "),r("h4",{attrs:{id:"部分复制"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#部分复制"}},[t._v("#")]),t._v(" 部分复制")]),t._v(" "),r("p",[t._v("用于网络中断等情况后的复制，只将中断期间主节点执行的写命令发送给从节点，与全量复制相比更加高效。需要注意的是，如果网络中断时间过长，导致主节点没有能够完整地保存中断期间执行的写命令，则无法进行部分复制，仍使用全量复制")]),t._v(" "),r("p",[r("img",{attrs:{src:a(451),alt:""}})])])}),[],!1,null,null,null);s.default=v.exports}}]);